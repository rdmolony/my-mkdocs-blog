
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<link href="../../assets/images/favicon.png" rel="icon"/>
<meta content="mkdocs-1.3.1, mkdocs-material-8.4.0" name="generator"/>
<title>Cache docker compose images via github actions - rdmolony.github.io</title>
<link href="../../assets/stylesheets/main.69437709.min.css" rel="stylesheet"/>
<link href="../../assets/stylesheets/palette.cbb835fc.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body data-md-color-accent="indigo" data-md-color-primary="white" data-md-color-scheme="default" dir="ltr">
<script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#context">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="rdmolony.github.io" class="md-header__button md-logo" data-md-component="logo" href="../.." title="rdmolony.github.io">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"></path></svg>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            rdmolony.github.io
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Cache docker compose images via github actions
            
          </span>
</div>
</div>
</div>
<form class="md-header__option" data-md-component="palette">
<input aria-label="Switch to dark mode" class="md-option" data-md-color-accent="indigo" data-md-color-media="(prefers-color-scheme: light)" data-md-color-primary="white" data-md-color-scheme="default" id="__palette_1" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_2" hidden="" title="Switch to dark mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"></path></svg>
</label>
<input aria-label="Switch to light mode" class="md-option" data-md-color-accent="indigo" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-primary="white" data-md-color-scheme="slate" id="__palette_2" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_1" hidden="" title="Switch to light mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"></path></svg>
</label>
</form>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Search" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"></path></svg>
</label>
<nav aria-label="Search" class="md-search__options">
<button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"></path></svg>
</button>
</nav>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list"></ol>
</div>
</div>
</div>
</div>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="rdmolony.github.io" class="md-nav__button md-logo" data-md-component="logo" href="../.." title="rdmolony.github.io">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"></path></svg>
</a>
    rdmolony.github.io
  </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../..">
        Welcome to my blog
      </a>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" id="__nav_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_2">
          Til
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Til" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
          Til
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../add-a-custom-column-to-django-tables2/">
        Add a custom column to django tables2
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../add-autocompletion-to-django-filters/">
        Add autocompletion to django filters
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../add-conda-to-the-powershell-profile/">
        Add conda to the powershell profile
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../add-hoverable-info-to-django-tables2-column-names/">
        Add hoverable info to django tables2 column names
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../backup-files-from-wsl-to-onedrive/">
        Backup files from wsl to onedrive
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../block-duplicate-records-being-saved-in-django/">
        Block duplicate records being saved in django
      </a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" data-md-toggle="toc" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
          Cache docker compose images via github actions
          <span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="./">
        Cache docker compose images via github actions
      </a>
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#context">
    Context
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#satackeyaction-docker-layer-caching">
    satackey/action-docker-layer-caching
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#dockerbake-action">
    docker/bake-action
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#github-actions">
    github-actions
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#docker">
    docker
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#docker-compose">
    docker-compose
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../cache-package-manager-installs-with-buildkit/">
        Cache package manager installs with buildkit
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../cache-wget-installs-with-buildkit/">
        How to cache wget installs with buildkit
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../cascade-on-delete/">
        Cascade on delete
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../checkout-submodules-in-github-actions/">
        Checkout submodules in github actions
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../commit-per-file-via-sh/">
        Commit per file via sh
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../compare-files-for-equality-in-python/">
        Compare files for equality in python
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../connect-to-mssql-db-via-sqlalchemy/">
        Connect to mssql db via sqlalchemy
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../create-a-test-mysql-database-via-pytest-django/">
        Create a test mysql database via pytest-django
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../deploy-docker-compose-images-via-github-actions/">
        Deploy docker compose images via github actions
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../estimate-wind-speed-forecast-uncertainty/">
        Estimate wind speed forecast uncertainty
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../filter-django-models-via-null-fields/">
        Filter django models via null fields
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../finding-the-first-true-value-in-a-list-via-python/">
        Finding the first true value in a list via python
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../flag-wind-turbine-timestamps-in-fault-time-intervals/">
        Flag wind turbine timestamps in fault time intervals
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../git-push-periodically-via-cron/">
        Git push periodically via cron
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../index-last-month-via-pandas/">
        Index last month via pandas
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../install-packages-on-shell-startup/">
        Install packages on shell startup
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../install-python-packages-on-ubuntu-with-c-dependencies/">
        Install python packages on ubuntu with c dependencies
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../installing-powershell-modules-on-first-launch/">
        Installing powershell modules on first launch
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../login-to-a-django-app-via-selenium-and-pytest-django/">
        Login to a django app via selenium and pytest django
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../map-django-models-one-to-one/">
        Map django models one to one
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../mock-requesting-a-file-from-an-external-website-in-pytest/">
        Mock requesting a file from an external website in pytest
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../monkeypatch-a-database-connection-in-pytest/">
        How to monkeypatch a database connection
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../monkeypatch-functions-with-mock/">
        Monkeypatch functions with mock
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../override-django-huey-immediate-mode/">
        How to run `djhuey` tasks in immediate mode
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../passing-file-contents-to-package-manager-via-xargs/">
        Passing file contents to package manager via xargs
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../restore-a-mysql-database-on-docker-compose/">
        Restore a mysql database on docker compose
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../run-django-via-docker-compose/">
        How to run django via docker compose
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../run-multiple-commands-on-docker-container-startup/">
        Run multiple commands on docker container startup
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../running-scripts-on-launch/">
        Running scripts on launch
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../save-files-via-django-modelform/">
        Save files via django modelform
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../select-all-text-between-two-strings-across-lines-via-regex/">
        Select all text between two strings across lines via regex
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../speed-up-table-load-via-prefetch/">
        Speed up table load via prefetch
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../styling-powershell-with-oh-my-posh/">
        Styling Powershell with [`oh-my-posh`](https://github.com/jandedobbeleer/oh-my-posh)
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../switch-selenium-user-within-a-test/">
        Switch selenium user within a test
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../test-a-django-app-on-docker-via-selenium-2/">
        Test a django app on docker via selenium 2
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../test-a-django-app-on-docker-via-selenium/">
        Test a django app on docker via selenium
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../test-huey-tasks/">
        Test huey tasks
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../update-git-submodules/">
        Update git submodules
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../update-parent-repo-on-submodule-update-via-github-actions/">
        Update parent repo on submodule update via github actions
      </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#context">
    Context
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#satackeyaction-docker-layer-caching">
    satackey/action-docker-layer-caching
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#dockerbake-action">
    docker/bake-action
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#github-actions">
    github-actions
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#docker">
    docker
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#docker-compose">
    docker-compose
  </a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<blockquote>
<p><strong>TLDR</strong>
As of 2022-06-23 both <a href="https://github.com/docker/bake-action">docker/bake-action</a> or <a href="https://github.com/satackey/action-docker-layer-caching">satackey/action-docker-layer-caching</a>are good options.  I had to hack around a little to use access the cached images in <code>docker compose</code> across multiple <code>GitHub Actions</code> steps.  See the relevant sections below for more information. </p>
</blockquote>
<h2 id="context">Context<a class="headerlink" href="#context" title="Permanent link">¶</a></h2>
<p>I wanted to setup  <code>GitHub Actions</code> so that our test suite runs on all pull request or pushes to the <code>main</code> branch so that any changes don't break existing functionality.</p>
<p>Specifically, we use <code>docker compose</code> at <code>mainstreamrp-dev</code> to setup a development environment for our <code>Django</code> web app.  Our integration tests interact with <code>Selenium</code> (browser automation), <code>Microsoft SQL Server</code> &amp; <code>MySQL</code> (databases) via <code>docker compose</code>.  To set it up <code>Docker</code> reads  a <code>Dockerfile</code> which specifies the system dependencies required to run the web app and stores the result in an image; we use <code>python-poetry</code> for <code>Python</code> and  <code>apt</code> for <code>Ubuntu</code>.  If any of these dependencies change we need to rebuild the image which can take several minutes.  If they don't change between test runs I'd rather not wait several minutes every time and use caching to access a prebuilt image.</p>
<p>As of 2022-06-23 setting up this caching was tricky.  </p>
<p>I created <a href="https://github.com/rdmolony/cache-docker-compose-images">rdmolony/cache-docker-compose-images</a> to experiment with 3rd party packages to do this for me:
- <a href="https://github.com/docker/build-push-action">docker/build-push-action: GitHub Action to build and push Docker images with Buildx</a> - not recommended for <code>docker compose</code>
- <a href="https://github.com/docker/bake-action">docker/bake-action: GitHub Action to use Docker Buildx Bake as a high-level build command</a> - works
- <a href="https://github.com/satackey/action-docker-layer-caching">satackey/action-docker-layer-caching: 🐳 Enable Docker layer caching in GitHub Actions</a> - works</p>
<p>Using these packages I was able to cache in one step, but I found it hard to access this cached image via <code>docker compose</code> in subsequent steps.</p>
<h2 id="satackeyaction-docker-layer-caching"><a href="https://github.com/satackey/action-docker-layer-caching">satackey/action-docker-layer-caching</a><a class="headerlink" href="#satackeyaction-docker-layer-caching" title="Permanent link">¶</a></h2>
<p>The <a href="https://github.com/satackey/action-docker-layer-caching">satackey/action-docker-layer-caching</a> has good documentation.  On every new pull request or push the image is built from scratch &amp; on subsequent runs of <code>GitHub Actions</code> the cache is used instead.</p>
<p>The only tricky thing was to invalidate the cache if the <code>Dockerfile</code> (or a <code>poetry.lock</code> file) changes so that we rebuild the image. After a little hunting, I found I could use the builtin function <code>hashFiles</code> to create a unique hash based on the  <code>Dockerfile</code> which I could pass via the <code>key</code> &amp; <code>restore-keys</code> parameters to <a href="https://github.com/satackey/action-docker-layer-caching">satackey/action-docker-layer-caching</a> to invalidate the cache if this file changes.</p>
<pre><code class="language-yml"># This is a basic workflow to help you get started with Actions



name: CI



# Controls when the workflow will run

on:

# Triggers the workflow on push or pull request events but only for the "main" branch

push:

branches: [ "master" ]

pull_request:

branches: [ "master" ]



# Allows you to run this workflow manually from the Actions tab

workflow_dispatch:



env:

IMAGE_NAME: cache-docker-compose-images



# A workflow run is made up of one or more jobs that can run sequentially or in parallel

jobs:

# This workflow contains a single job called "build"

build:

# The type of runner that the job will run on

runs-on: ubuntu-latest



# Steps represent a sequence of tasks that will be executed as part of the job

steps:

# Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it

- uses: actions/checkout@v3



- name: Login to Docker Hub

uses: docker/login-action@v2

with:

username: ${{ secrets.DOCKERHUB_USERNAME }}

password: ${{ secrets.DOCKERHUB_TOKEN }}



# Pull the latest image to build, and avoid caching pull-only images.

# (docker pull is faster than caching in most cases.)

- run: docker-compose pull



# In this step, this action saves a list of existing images,

# the cache is created without them in the post run.

# It also restores the cache if it exists.

- uses: satackey/action-docker-layer-caching@v0.0.11

# Ignore the failure of a step and avoid terminating the job.

continue-on-error: true

with:

key: ${{ runner.os }}-${{ github.workflow }}-${{ hashFiles('**/Dockerfile') }}-{hash}

restore-keys: |

${{ runner.os }}-${{ github.workflow }}-${{ hashFiles('**/Dockerfile') }}

- name: Test

run: docker compose run web



- name: Tag image

run: docker tag $IMAGE_NAME:latest ${{ secrets.DOCKERHUB_USERNAME }}/$IMAGE_NAME:$GITHUB_SHA



- name: Push image to Docker Hub

run: docker push ${{ secrets.DOCKERHUB_USERNAME }}/$IMAGE_NAME:$GITHUB_SHA
</code></pre>
<h2 id="dockerbake-action"><a href="https://github.com/docker/bake-action">docker/bake-action</a><a class="headerlink" href="#dockerbake-action" title="Permanent link">¶</a></h2>
<p>With the help of @crazy-max I worked out how to get <code>docker compose run</code> to play nicely with <a href="https://github.com/docker/bake-action">docker/bake-action</a> </p>
<blockquote>
<p>See <a href="https://github.com/docker/bake-action/issues/81">How to access the bake-action cached image in subsequent steps? · Issue #81 · docker/bake-action (github.com)</a></p>
</blockquote>
<p>I needed to:
- Load environment variables  in a <code>.env</code> in <code>bash</code> in a step as this wasn't yet supported in <a href="https://github.com/docker/bake-action">docker/bake-action</a> 
- Specify <code>load: true</code> for the <code>bake-action</code> to save the <code>Docker</code> image so that the runner can access it in subsequent steps
- Set the image name in <code>docker-compose.yml</code> to the same name as the  <code>bake-action</code> </p>
<p><code>ci.yml</code>:</p>
<pre><code class="language-yml"># This is a basic workflow to help you get started with Actions



name: CI



# Controls when the workflow will run

on:

  # Triggers the workflow on push or pull request events but only for the "main" branch

  push:

    branches: [ "master" ]

  pull_request:

    branches: [ "master" ]



  # Allows you to run this workflow manually from the Actions tab

  workflow_dispatch:



env:

  IMAGE_NAME: rdmolony/web

  PUSH_TAG: ${{ github.sha }}



# A workflow run is made up of one or more jobs that can run sequentially or in parallel

jobs:

  # This workflow contains a single job called "build"

  build:

    # The type of runner that the job will run on

    runs-on: ubuntu-latest



    # Steps represent a sequence of tasks that will be executed as part of the job

    steps:

      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it

      - uses: actions/checkout@v3



      # bake-action does not yet load .env

      - name: Export .env to GITHUB_ENV

        run: cat .env &gt;&gt; $GITHUB_ENV



      - name: Set up Docker Buildx

        uses: docker/setup-buildx-action@v2



      - name: Build

        uses: docker/bake-action@v2.0.0

        with:

          push: false

          load: true

          set: |

            web.cache-from=type=gha

            web.cache-to=type=gha

            web.tags=${{ env.IMAGE_NAME }}

      - name: Test

        run: docker compose run web
</code></pre>
<p><code>docker-compose.yml</code>:</p>
<pre><code class="language-yml">version: "3.7"



services:

  web:

    build:

      context: .

    image: rdmolony/web

    command: echo "Test run successful!"
</code></pre>
<blockquote>
<p><strong>Note</strong>: <code>.env</code> must be loaded into <code>GITHUB_ENV</code> to use the variables across steps <a href="https://docs.github.com/en/actions/learn-github-actions/environment-variables#passing-values-between-steps-and-jobs-in-a-workflow">Environment variables - GitHub Docs</a></p>
</blockquote>
<p>This action caches between workflow runs!  This means that I won't have to rebuild if the image hasn't changed on the first pull request or push.  I couldn't figure this out easily using <a href="https://github.com/satackey/action-docker-layer-caching">satackey/action-docker-layer-caching</a> though I imagine it's possible provided the right hash key is used.</p>
<blockquote>
<p>See <a href="https://github.com/rdmolony/cache-docker-compose-images/pull/6">Cache via bake action reuse by rdmolony · Pull Request #6 · rdmolony/cache-docker-compose-images (github.com)</a></p>
</blockquote>
<h1 id="github-actions">github-actions<a class="headerlink" href="#github-actions" title="Permanent link">¶</a></h1>
<h1 id="docker">docker<a class="headerlink" href="#docker" title="Permanent link">¶</a></h1>
<h1 id="docker-compose">docker-compose<a class="headerlink" href="#docker-compose" title="Permanent link">¶</a></h1>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<nav aria-label="Footer" class="md-footer__inner md-grid">
<a aria-label="Previous: Block duplicate records being saved in django" class="md-footer__link md-footer__link--prev" href="../block-duplicate-records-being-saved-in-django/" rel="prev">
<div class="md-footer__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"></path></svg>
</div>
<div class="md-footer__title">
<div class="md-ellipsis">
<span class="md-footer__direction">
                Previous
              </span>
              Block duplicate records being saved in django
            </div>
</div>
</a>
<a aria-label="Next: Cache package manager installs with buildkit" class="md-footer__link md-footer__link--next" href="../cache-package-manager-installs-with-buildkit/" rel="next">
<div class="md-footer__title">
<div class="md-ellipsis">
<span class="md-footer__direction">
                Next
              </span>
              Cache package manager installs with buildkit
            </div>
</div>
<div class="md-footer__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"></path></svg>
</div>
</a>
</nav>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.ecf98df9.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
<script src="../../assets/javascripts/bundle.9c69f0bc.min.js"></script>
<script src="../../javascripts/mathjax.js"></script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</body>
</html>